apiVersion: "nuclio.io/v1"
kind: Function
metadata:
  name: light-on-control
  namespace: nuclio
spec:
  handler: "main:handler"
  description: "This function runs every minute, checks if there are any lights on for more than two minutes and if so, sends a message on the iot/lightsWarning topic."
  runtime: nodejs
  image: "nuclio/light-on-control:latest"
  minReplicas: 1
  maxReplicas: 1
  targetCPU: 75
  triggers:
    rangeTimeTrigger:
      kind: cron
      attributes:
        interval: 1m
  build:
    functionSourceCode: Y29uc3QgcmVkaXMgPSByZXF1aXJlKCJyZWRpcyIpOwpjb25zdCBtcXR0ID0gcmVxdWlyZSgnbXF0dCcpOwpjb25zdCB1cmwgPSByZXF1aXJlKCd1cmwnKTsKY29uc3QgeyBwcm9taXNpZnkgfSA9IHJlcXVpcmUoInV0aWwiKTsKCmNvbnN0IG1xdHRfdXJsID0gdXJsLnBhcnNlKHByb2Nlc3MuZW52LkNMT1VEQU1RUF9NUVRUX1VSTCB8fCAnbXF0dDovL2d1ZXN0Omd1ZXN0QHJhYmJpdG1xOjE4ODMnKTsKY29uc3QgYXV0aCA9IChtcXR0X3VybC5hdXRoIHx8ICc6Jykuc3BsaXQoJzonKTsKY29uc3QgbmV3VXJsID0gIm1xdHQ6Ly8iICsgbXF0dF91cmwuaG9zdDsKCnZhciBvcHRpb25zID0gewogIHBvcnQ6IG1xdHRfdXJsLnBvcnQsCiAgY2xpZW50SWQ6ICdtcXR0anNfJyArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMTYpLnN1YnN0cigyLCA4KSwKICB1c2VybmFtZTogYXV0aFswXSwKICBwYXNzd29yZDogYXV0aFsxXSwKfTsKCmV4cG9ydHMuaGFuZGxlciA9IGZ1bmN0aW9uKGNvbnRleHQsIGV2ZW50KSB7CiAgY29uc3QgbXF0dENsaWVudCA9IG1xdHQuY29ubmVjdChuZXdVcmwsIG9wdGlvbnMpOwogIGNvbnN0IHJlZGlzQ2xpZW50ID0gcmVkaXMuY3JlYXRlQ2xpZW50KHtob3N0OiAicmVkaXMifSk7CiAgY29uc3QgZ2V0QXN5bmMgPSBwcm9taXNpZnkocmVkaXNDbGllbnQuZ2V0KS5iaW5kKHJlZGlzQ2xpZW50KTsKCiAgbXF0dENsaWVudC5vbignY29ubmVjdCcsICgpID0+IHsKICAgIHJlZGlzQ2xpZW50LmtleXMoJyonLCAoZXJyLCBrZXlzKSA9PiB7CiAgICAgIGlmKGVycikgY29udGV4dC5jYWxsYmFjaygiRVJST1IiKTsKICAgICAgaWYoa2V5cy5sZW5ndGggPT09IDApIHsKICAgICAgICBtcXR0Q2xpZW50LmVuZCgpOwogICAgICAgIGNvbnRleHQuY2FsbGJhY2soIk5vIGxpZ2h0IG9uIik7CiAgICAgIH0KICAgICAga2V5cy5mb3JFYWNoKGFzeW5jIChrZXksIGksIGFycikgPT4gewogICAgICAgIGNvbnN0IGxpZ2h0RGF0ZSA9IGF3YWl0IGdldEFzeW5jKGtleSk7CiAgICAgICAgY29uc3QgZGlmZmVyZW5jZSA9IChuZXcgRGF0ZSgpIC0gbmV3IERhdGUobGlnaHREYXRlKSkvMTAwMC82MAogICAgICAgIGlmKGRpZmZlcmVuY2UgPj0gMikgewogICAgICAgICAgbXF0dENsaWVudC5wdWJsaXNoKCdpb3QvbGlnaHRzV2FybmluZycsIGtleSwgKCkgPT4gewogICAgICAgICAgICBpZihhcnIubGVuZ3RoIC0gMSA9PT0gaSkgewogICAgICAgICAgICAgIG1xdHRDbGllbnQuZW5kKCk7CiAgICAgICAgICAgICAgY29udGV4dC5jYWxsYmFjaygiTm90aWZpY2F0aW9ucyBzZW50ISIpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KQogICAgfSk7CiAgfSk7CgogIC8vIGNsaWVudC5xdWl0KCk7Cn07Cg==
    commands:
      - 'npm install redis'
      - 'npm install mqtt'
    codeEntryType: sourceCode
  platform:
    attributes:
      network: lightson_default
